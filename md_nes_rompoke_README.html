<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>llvm-mos-sdk: rompoke.h - &quot;safe&quot; ROM writing for mappers with bus conflicts</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">llvm-mos-sdk
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">rompoke.h - "safe" ROM writing for mappers with bus conflicts </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The NES features mapper bus conflicts. Simpler mappers, based around discrete logic chips, do not prevent the ROM chip from being enabled when the CPU is writing to the cartridge's data bus - this creates a conflict, as both the CPU and ROM are outputting values on the same bus at the same time.</p>
<p>The correct way to work around this is to ensure that the value output by the CPU is the same as outputting the ROM. This is typically done by creating a byte array <code>A</code> where, for any given value <code>N</code>, <code>A[N] == N</code>; then, whenever one wants to write <code>N</code> to ROM, it is done to the address of <code>A[N]</code>.</p>
<p>However, this byte array would normally take up 256 bytes of the 16384 bytes typically present in the "fixed" ROM. Many mappers only require a far smaller table; for example, an UNROM cartridge typically only has 16 banks, so the only values one would need to write to the ROM bus will be between 0 and 15.</p>
<p>The solution presented here - <code>rompoke.*</code> and <code>rompoke-table.ld</code> - allows the LLVM-MOS SDK to dynamically allocate, at link time, a minimally-sized array based on the INES header configuration.</p>
<h1><a class="anchor" id="autotoc_md6"></a>
Adding a new mapper</h1>
<p>To add a new mapper, one has to define a file called <code>_rompoke.ld</code> in their mapper's directory. This file will determine the size of the byte array <code>A</code>, from 0 - no bus conflicts - to 256 bytes. As such, at its simplest, one can define the file as follows:</p>
<div class="fragment"><div class="line">__rom_poke_table_size = 256;</div>
</div><!-- fragment --><p>This will be functional, if usually wasteful of ROM space. Ideally, one would vary this value dynamically depending on the configuration of the INES header. At the same time, however, typing all the necessary conditions by hand would be tedious, especially for mappers with more than one variable - this is where <code><a class="el" href="generate-rompoke-mapper-linkscript_8lua.html">generate-rompoke-mapper-linkscript.lua</a></code> comes in. The script will generate the necessary <code>_rompoke.ld</code> file for you; it requires Lua 5.4.</p>
<p>To add a new mapper to the generator script, one should populate the <code>CONFIG_MAP</code> table at the top of the script with a new key, corresponding to their mapper. The value should be in the form of a table containing the mapper's bitfields in order.</p>
<p>Let's use the example of a simple mapper - UNROM. It is defined as follows:</p>
<div class="fragment"><div class="line">7  bit  0</div>
<div class="line">---- ----</div>
<div class="line">pppp PPPP</div>
<div class="line">|||| ||||</div>
<div class="line">++++-++++- 16K PRG-ROM bank ID</div>
<div class="line">           Mapped at $8000-$BFFF</div>
</div><!-- fragment --><p>A ROM with 256 PRG-ROM banks would take up 4 MB. Most games are considerably smaller than this; for example, a 256 KB game will only use 16 banks, and thus require safe ROM write support for values 0 - 15 only.</p>
<p>Let's codify this in the link script's configuration format. Each bitfield is defined using a table which can have one of the following formats:</p>
<ul>
<li><code>{bitwidth, nil}</code> - can be 0 or 1 irrespective of INES configuration,</li>
<li><code>{bitwidth, 0}</code> - always 0,</li>
<li><code>{bitwidth, 1}</code> - always 1,</li>
<li><code>{bitwidth, expr, comparator[, step]}</code> - conditional based on value of expression:<ul>
<li><code>&gt;</code>: <code>value</code> is maximum if <code>expr &gt; (value * step)</code>,</li>
<li><code>&gt;log2</code>: as above, but in log2(...) progression; for a step of 16, values {16, 32, 64, 128, ...} would be used,</li>
<li><code>==</code>: <code>value</code> is maximum if <code>expr</code> is true.</li>
</ul>
</li>
</ul>
<p>For UNROM, we'd like to use the <code>&gt;log2</code> conditional comparator for each 16K PRG-ROM bank. The linker defines a <code>__prg_rom_size</code> value in kilobytes; as such, one can model it as follows:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    8, -- 8 bit-wide field</div>
<div class="line">    &quot;__prg_rom_size&quot;, -- expression</div>
<div class="line">    &quot;&gt;log2&quot;, -- conditional comparator</div>
<div class="line">    16 -- step</div>
<div class="line">}</div>
</div><!-- fragment --><p>In addition, one can define a condition under which no bus conflicts occur - in this case, an empty table will be generated, occupying no ROM space. For UNROM, this is the case when the <code>__submapper</code> value is 1; one can then write the following into their script:</p>
<div class="fragment"><div class="line">[&quot;none_if&quot;] = &quot;__submapper == 1&quot;</div>
</div><!-- fragment --><p>Once you've defined the configuration for your mapper, call <code>lua <a class="el" href="generate-rompoke-mapper-linkscript_8lua.html">generate-rompoke-mapper-linkscript.lua</a> unrom-512 &gt; ../../../nes-unrom512/_rompoke.ld</code>. You're done! </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
